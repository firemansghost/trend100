name: Extend EOD Cache

on:
  workflow_dispatch:
    inputs:
      max_symbols:
        description: 'Maximum number of symbols to extend per run (default: 200)'
        required: false
        default: '200'
        type: string
      cache_days:
        description: 'Target cache days (default: 1600)'
        required: false
        default: '1600'
        type: string

# Concurrency: single-writer rule for generated artifacts
# All workflows that commit generated JSON to main must share this group
concurrency:
  group: trend100-cache-writer
  cancel-in-progress: true

jobs:
  extend:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Extend cache and commit
        env:
          DATA_PROVIDER: marketstack
          MARKETSTACK_API_KEY: ${{ secrets.MARKETSTACK_API_KEY }}
          MARKETSTACK_CACHE_DAYS: ${{ inputs.cache_days || '1600' }}
          MARKETSTACK_EXTEND_MAX_SYMBOLS: ${{ inputs.max_symbols || '200' }}
        run: |
          set -euo pipefail
          
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          MAX_RETRIES=3
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_RETRIES ]; do
            echo "=========================================="
            echo "Attempt $ATTEMPT/$MAX_RETRIES: syncing to origin/main..."
            echo "=========================================="
            
            # Step 1: Sync to latest origin/main
            git fetch origin main
            git checkout main
            git reset --hard origin/main
            
            echo "Current HEAD: $(git rev-parse HEAD)"
            echo "Origin/main:  $(git rev-parse origin/main)"
            echo ""
            
            # Step 2: Run snapshot update to trigger cache extension
            # This will extend caches up to MARKETSTACK_EXTEND_MAX_SYMBOLS symbols
            echo "Extending EOD cache (max ${{ inputs.max_symbols || '200' }} symbols)..."
            echo "Note: This runs update:snapshots which will extend caches as needed."
            echo ""
            pnpm update:snapshots || {
              echo "⚠️  update:snapshots failed, but cache extension may have partially completed"
              echo "Continuing to check for cache changes..."
            }
            
            # Step 3: Stage only EOD cache files (not snapshots/health-history)
            echo ""
            echo "Staging EOD cache files..."
            git add data/marketstack/eod/*.json
            
            # Step 4: Check if there are changes
            if [ -z "$(git diff --cached --name-only)" ]; then
              echo "No cache changes to commit."
              exit 0
            fi
            
            # Step 5: Commit
            echo ""
            echo "Committing cache extensions..."
            git commit -m "chore: extend EOD cache for indicator lookback [skip ci]"
            
            # Step 6: Push
            echo ""
            echo "Pushing to origin/main..."
            if git push origin HEAD:main; then
              echo ""
              echo "✅ Push succeeded on attempt $ATTEMPT"
              exit 0
            fi
            
            echo ""
            echo "⚠️  Push failed (remote moved). Retrying..."
            ATTEMPT=$((ATTEMPT + 1))
            echo ""
          done
          
          echo ""
          echo "❌ Push failed after $MAX_RETRIES attempts."
          exit 1
