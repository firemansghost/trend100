# CHECKS — Trend100

## Verification Steps (V1 MVP)

### Engine correctness
- Unit tests for SMA and EMA on deterministic sequences
- Weekly resample:
  - Derived from daily bars
  - Weekly close uses Friday close (handle market holidays consistently)
- Classification:
  - Green/Yellow/Red matches rules for known scenarios
  - Insufficient history returns **UNKNOWN** (or equivalent) consistently

### UI behavior
- Heatmap renders **exactly 100 tiles** from snapshot
- Search filters by ticker instantly
- Tag filters apply correctly (document AND/OR behavior when implemented)
- Modal:
  - Opens via click
  - Closes via Esc + click-outside
  - Mobile-friendly layout

### Data layer architecture
- UI consumes `getLatestSnapshot()` only (no hidden direct API calls)
- Swapping mock → real provider touches **data layer only**

### Shareability
- Metadata/OG tags show correct title/description on social previews

## Environment & Local Development

### .env.local loading
- Scripts automatically load `.env.local` (then `.env` as fallback) via side-effect import
- All scripts import `'./load-env'` as the first import (ESM import order requirement)
- CI env vars take precedence (override: false) — local .env.local doesn't override CI secrets

### update:snapshots behavior
- Extends EOD cache up to configured budget (`MARKETSTACK_EXTEND_MAX_SYMBOLS`, default: 10)
- Skips wasting budget on inception-limited symbols (uses metadata in `data/marketstack/eod/.meta/`)
- Fetches "latest" for symbols with recent cache (batched updates)
- Logs clear messages for inception-limited symbols: `"ℹ️ <SYMBOL> cannot extend earlier than <date> (provider limit/inception)"`

### CI pipeline checks
- **Artifact validation:** CI must pass `pnpm update:snapshots && pnpm update:turbulence-gates && pnpm verify:artifacts` before deploy (vercel-prebuilt-prod.yml on push; daily-artifacts-deploy.yml on schedule)
- **FRED_API_KEY:** Required secret for turbulence gates generation; must be set in GitHub Actions secrets for both deploy workflows
- **Daily deploy:** `daily-artifacts-deploy.yml` runs Mon–Fri 22:15 UTC; must pass update:snapshots + verify:artifacts before deploying
- **Production smoke checks:** After deploy, key artifact endpoints should return 200:
  - https://trend100.vercel.app/snapshot.MACRO.json
  - https://trend100.vercel.app/health-history.MACRO.json

### verify:artifacts checks
- **Turbulence gates:** Validates `public/turbulence.gates.json`:
  - File exists, is an array, ≥250 points
  - Sorted ascending by date
  - Last point date within 7 calendar days (fails if stale to prevent stale deploys)
  - Null rules: if `spx` or `spx50dma` is null, `spxAbove50dma` must be null; if `vix` is null, `vixBelow25` must be null
  - At least one non-null `spx50dma` (ensures compute is not broken)
- EOD cache spans align with retention target (`MARKETSTACK_CACHE_DAYS`, default: 2300 calendar days)
- Inception-limited tickers show `"ℹ️ (limited history: inception)"` instead of `"⚠️ (needs extension)"`
- Health-history spans remain consistent (no unexpected shrinkage)
- Shows cache depth, point counts, and date ranges per deck (includes all decks via `getAllDeckIds()`)
- **Health history validation:** Fails if weekend points (Saturday/Sunday) or partial-schema points (missing required fields) are found
- **New deck artifacts:** After adding a deck, verify `public/snapshot.<DECK_ID>.json` and `public/health-history.<DECK_ID>.json` are generated by `pnpm update:snapshots`
- **Grouped decks:** If a deck has grouped tickers (e.g., METALS_MINING), `verify:artifacts` also requires and validates:
  - `public/health-history.<DECK>.metals.json`
  - `public/health-history.<DECK>.miners.json`
- **Non-grouped multi-section decks:** If a deck has no groups but has ≥2 sections (e.g., US_FACTORS, FIXED_INCOME, MACRO), `verify:artifacts` also requires and validates:
  - `public/health-history.<DECK>.<sectionKey>.json` for each section (sectionKey from `toSectionKey(section.id)`, e.g. `quality-lowvol`, `global-ex-us`, `loans-bdc`, `em-debt`). Weekend and partial-schema rules apply to all section files.

## Troubleshooting

### "MARKETSTACK_API_KEY environment variable is not set"
- **Fix:** Create `.env.local` in repo root with `MARKETSTACK_API_KEY=your_key_here`
- **Verify:** Scripts import `'./load-env'` as first import (check `scripts/*.ts` files)

### "FRED_API_KEY environment variable is required"
- **Fix:** Add `FRED_API_KEY=your_key_here` to `.env.local` for local runs; ensure `FRED_API_KEY` is set as a GitHub Actions secret for CI
- **Use case:** Required by `update:turbulence-gates` to fetch SP500 and VIXCLS from FRED

### "Needs extension but budget exhausted"
- **Fix:** Increase `MARKETSTACK_EXTEND_MAX_SYMBOLS` (default: 10) or run multiple times
- **Note:** Inception-limited symbols are automatically excluded from extension attempts

### "Force retry inception-limited symbol"
- **Fix:** Set `MARKETSTACK_FORCE_EXTEND=1` to override inception-limited metadata check
- **Use case:** When you suspect metadata is stale or want to retry after provider adds history

### "Mystery weekend dip in chart"
- **Fix:** Health history sanitization automatically removes weekend points. If you see this:
  - Run `pnpm verify:artifacts` to check for weekend/partial points
  - If found, regenerate health history: `pnpm update:snapshots` (sanitization runs on load)
  - Verify: `grep -E '"date": "202[0-9]-[0-9]{2}-(0[6]|1[0-9]|2[0-9]|3[01])"' public/health-history.*.json` should return nothing (no Sat/Sun dates)

### "Pills change heatmap but not chart"
- **Symptom:** Selecting a section pill (e.g., Quality/LowVol) filters the ticker list but the chart still shows the full-deck series.
- **Cause:** Section-variant health-history files are missing or URL `section=` does not match the file naming (sectionKey).
- **Fix:**
  - Run `MARKETSTACK_OFFLINE=1 pnpm update:health-history -- --backfill-days 30` (or `pnpm update:snapshots`) so that `public/health-history.<DECK>.<sectionKey>.json` are generated for each section.
  - Run `pnpm verify:artifacts` to confirm all required section files exist and pass validation.
  - Section key must match `toSectionKey(section.id)` (e.g. `Quality/LowVol` → `quality-lowvol`). If you added a new section, ensure deck `sections` use the same `id` as ticker `section` and that writers use `toSectionKey` from `@/modules/trend100/data/sectionKey`.

### "Missing symbols in new deck"
- **Symptom:** New deck (e.g., METALS_MINING) shows fewer tickers than expected in UI or verify:artifacts reports missing EOD cache.
- **Fix:** 
  - Check `data/marketstack/eod/<SYMBOL>.json` exists for all tickers in deck universe
  - Run `pnpm update:snapshots` to backfill missing EOD cache and generate snapshots
  - Verify: `pnpm verify:artifacts` should show all decks including new one
  - For METALS_MINING: ensure GLTR, GLDM, SLV, PPLT, PALL, GDX, GDXJ, SIL, SILJ, XME, PICK have EOD cache

### "Workflow canceled: higher priority waiting request for trend100-cache-writer"
- **Symptom:** Scheduled "Update Snapshots" workflow gets canceled with message about concurrency group.
- **Fix:** This should no longer happen after consolidating scheduled writers. Only "Update Snapshots" is scheduled; other writer workflows (Update Health History, Backfill Health History, Extend EOD Cache) are manual-only. Writer workflows now queue (`cancel-in-progress: false`) instead of canceling each other.
- **Expected behavior:** If multiple writer workflows trigger (e.g., scheduled Update Snapshots + manual dispatch), they queue and run sequentially, not cancel.

### "Backfill workflow failing verify:artifacts due to partial-schema UNKNOWN points"
- **Symptom:** Backfill Health History workflow fails with "Found N partial-schema point(s)" error, typically for new decks or early history periods with insufficient data.
- **Root cause:** UNKNOWN points (insufficient history/warm-up) were previously written with null percentages or missing diffusion fields, which fails the strict schema validator.
- **Fix:** All UNKNOWN points now use `makeUnknownPoint()` helper which ensures:
  - `greenPct: 0, yellowPct: 0, redPct: 0` (not null)
  - `diffusionPct: 0, diffusionCount: 0, diffusionTotalCompared: totalTickers` (all finite numbers)
- **Verification:** After backfill, run `pnpm verify:artifacts` - should report 0 partial-schema points for all decks.
- **Note:** UNKNOWN points are still included in history files (for timeline continuity) but use 0/0/0 percentages and won't be plotted in charts.

### "Chart doesn't change when toggling Metals/Miners"
- **Expected behavior:** For grouped decks, the chart should change by loading a different health-history file.
- **Verify files exist:**
  - `public/health-history.METALS_MINING.json`
  - `public/health-history.METALS_MINING.metals.json`
  - `public/health-history.METALS_MINING.miners.json`
- **Fix:** Regenerate histories:
  - Backfill (offline): `MARKETSTACK_OFFLINE=1 pnpm -s update:health-history -- --backfill-days 2300`
  - Daily writer: `pnpm -s update:snapshots`
  - Then: `pnpm -s verify:artifacts`

### "100% green flatline (chart looks useless)"
- **Cause:** It can be legitimate for every ticker to stay GREEN for long periods, pinning GREEN% at 100.
- **Fix:** Switch chart metric using the metric selector (or URL):
  - `?metric=heat` (Heat score 0–100)
  - `?metric=upper` (% Above Upper Band)
  - `?metric=stretch` (Stretch vs 200D median %)
- **Verify data:** `pnpm -s verify:artifacts` enforces the extra fields exist and are finite numbers on every point.

## Known Failure Modes
- Off-by-one MA windows and "lookahead" bugs
- Weekly resample picking wrong day (Thu vs Fri) around holidays
- NaN propagation / missing-bar edge cases
- UI re-implementing classification logic (engine drift)
- "As-of date" confusion (timezone/date parsing)
- Cache extension budget exhausted on inception-limited symbols (now handled via metadata)
